<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ur Flight Mate - Book Your Trip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* A simple fade-in animation for modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            animation: slideIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide all 'views' by default */
        .app-view {
            display: none;
        }
        
        /* Fix for date input placeholder text color */
        input[type="date"]:invalid::-webkit-calendar-picker-indicator {
            opacity: 0.6;
        }

        /* --- NEW: Hide elements based on login state --- */
        .logged-in { display: none; }
        .logged-out { display: none; }

        /* --- NEW: Better empty state messages --- */
        .empty-message {
            text-align: center;
            font-size: 1.125rem; /* text-lg */
            color: #4B5563; /* text-gray-600 */
            padding-top: 1rem;
            padding-bottom: 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-100 leading-normal tracking-normal">

    <nav class="bg-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-indigo-600 cursor-pointer" onclick="showView('search-view')">Ur Flight Mate</h1>
            
            <div class="space-x-4 flex items-center">
                <button class="logged-in text-lg font-medium text-gray-700 hover:text-indigo-600" onclick="showView('search-view')">Book</button>
                <button class="logged-in text-lg font-medium text-gray-700 hover:text-indigo-600" onclick="showView('my-flights-view')">Your Flights</button>
                <span id="nav-user-name" class="logged-in text-gray-500"></span>
                <button class="logged-in text-lg font-medium text-indigo-600 hover:text-indigo-800" onclick="logoutUser()">Logout</button>
                
                <button class="logged-out text-lg font-medium text-gray-700 hover:text-indigo-600" onclick="showView('login-view')">Login</button>
                <button class="logged-out text-lg font-medium bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700" onclick="showView('signup-view')">Sign Up</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 mt-8">

        <div id="search-view" class="app-view">
            <div class="bg-indigo-700 text-white rounded-lg shadow-lg p-8 md:p-12 mb-8">
                <h2 class="text-4xl font-bold mb-4">Book Your Next Flight</h2>
                <p class="text-xl text-indigo-200 mb-6">Find the best deals with our real-time dynamic pricing engine.</p>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        
                        <div>
                            <label for="origin-select" class="block text-sm font-medium text-gray-700">Origin</label>
                            <select id="origin-select" name="origin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-gray-900" required>
                                <option value="">Select a city...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="destination-select" class="block text-sm font-medium text-gray-700">Destination</label>
                            <select id="destination-select" name="destination" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-gray-900" required>
                                <option value="">Select a city...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-gray-900" required>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" id="search-button" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                Search Flights
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="results-view" class="app-view">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-semibold">Search Results</h2>
                <button onclick="showView('search-view')" class="text-indigo-600 hover:text-indigo-800 font-medium">&larr; Back to Search</button>
            </div>
            <div id="results-list" class="space-y-4">
                </div>
            <div id="results-message" class="empty-message"></div>
        </div>

        <div id="confirmation-view" class="app-view">
            <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-semibold mb-2">Booking Confirmed!</h2>
                <p class="text-lg">Your booking is complete. Your Passenger Name Record (PNR) is:</p>
                <p id="pnr-display" class="text-5xl font-mono font-bold my-4"></p>
                <p class="text-lg">This booking has been added to 'Your Flights'.</p>
                <div class="mt-6 space-x-4">
                    <button onclick="showView('search-view')" class="bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700">Book Another Flight</button>
                    <button id="download-receipt-btn" class="bg-gray-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-gray-700">Download Receipt (JSON)</button>
                </div>
            </div>
        </div>
        
        <div id="login-view" class="app-view">
            <div id="session-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4 max-w-lg mx-auto"></div>
            
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-lg mx-auto">
                <h2 class="text-3xl font-semibold mb-6 text-center">Login</h2>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-gray-900" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-gray-900" required>
                        </div>
                        <div id="login-error" class="hidden text-red-600 text-sm"></div>
                        <button type="submit" id="login-button" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700">
                            Login
                        </button>
                    </div>
                </form>
                <p class="text-center text-gray-600 mt-4">
                    Don't have an account? 
                    <button class="text-indigo-600 hover:underline" onclick="showView('signup-view')">Sign Up</button>
                </p>
            </div>
        </div>
        
        <div id="signup-view" class="app-view">
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-lg mx-auto">
                <h2 class="text-3xl font-semibold mb-6 text-center">Create Your Account</h2>
                <form id="signup-form">
                    <div class="space-y-4">
                        <div>
                            <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="signup-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-gray-900" required>
                        </div>
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="signup-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-gray-900" required>
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="signup-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-gray-900" required>
                        </div>
                        <div id="signup-error" class="hidden text-red-600 text-sm"></div>
                        <div id="signup-success" class="hidden text-green-600 text-sm"></div>
                        <button type="submit" id="signup-button" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700">
                            Create Account
                        </button>
                    </div>
                </form>
                <p class="text-center text-gray-600 mt-4">
                    Already have an account? 
                    <button class="text-indigo-600 hover:underline" onclick="showView('login-view')">Login</button>
                </p>
            </div>
        </div>

        <div id="my-flights-view" class="app-view">
            <h2 class="text-3xl font-semibold mb-6">Your Booked Flights</h2>
            <div id="my-flights-list" class="space-y-4">
                </div>
            <div id="my-flights-message" class="empty-message"></div>
        </div>
    </main>
    
    <footer class="text-center p-4 mt-12 text-gray-500">
        &copy; 2025 Ur Flight Mate. All rights reserved.
    </footer>

    <div id="booking-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-lg max-w-lg mx-auto mt-20">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Confirm Your Booking</h2>
                <button onclick="closeModal('booking-modal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <div id="modal-flight-details" class="mb-4 p-4 bg-gray-50 rounded-md">
                <p><strong>Flight:</strong> <span id="modal-flight-number"></span></p>
                <p><span id="modal-origin"></span> &rarr; <span id="modal-destination"></span></p>
                <p><strong>Price:</strong> <span id="modal-price" class="text-xl font-bold text-indigo-600"></span></p>
            </div>
            
            <p class="text-gray-700 mb-4">You are booking as: <strong id="modal-user-name"></strong></p>

            <form id="booking-form">
                <input type="hidden" id="modal-flight-id">
                <div class="space-y-4">
                    <div>
                        <label for="seat-select" class="block text-sm font-medium text-gray-700">Select Seat</label>
                        <select id="seat-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-gray-900" required>
                            <option value="" disabled selected>Choose a seat...</option>
                        </select>
                    </div>
                    
                    <div id="booking-error" class="hidden text-red-600 text-sm"></div>
                    <button type="submit" id="confirm-booking-button" class="w-full bg-green-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-green-700">
                        Confirm & Pay
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-lg max-w-lg mx-auto mt-20">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Booking Details</h2>
                <button onclick="closeModal('manage-modal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <div id="manage-modal-body" class="space-y-3">
                </div>

            <div id="manage-modal-error" class="hidden text-red-600 text-sm mt-4"></div>
            <div id="manage-modal-success" class="hidden text-green-600 text-sm mt-4"></div>

            <div id="manage-modal-actions" class="mt-6 flex space-x-4">
                 <button id="cancel-booking-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-red-700">
                    Cancel Booking
                </button>
                 <button id="download-manage-receipt-btn" class="w-full bg-gray-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-gray-700">
                    Download Receipt (JSON)
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Globals ---
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        // --- NEW: City list for dropdowns ---
        const CITIES = [
            "New York (JFK)", "Los Angeles (LAX)", "Chicago (ORD)", "Miami (MIA)",
            "San Francisco (SFO)", "Boston (BOS)", "London (LHR)", "Tokyo (NRT)",
            "Paris (CDG)", "Dubai (DXB)", "Mumbai (BOM)", "Delhi (DEL)",
            "Bangalore (BLR)", "Kolkata (CCU)"
        ];
        
        // Views
        const views = document.querySelectorAll('.app-view');
        
        // Search
        const searchForm = document.getElementById('search-form');
        const searchButton = document.getElementById('search-button');
        const resultsList = document.getElementById('results-list');
        const resultsMessage = document.getElementById('results-message');
        const originSelect = document.getElementById('origin-select');
        const destinationSelect = document.getElementById('destination-select');
        
        // Booking Modal
        const bookingModal = document.getElementById('booking-modal');
        const bookingForm = document.getElementById('booking-form');
        const bookingError = document.getElementById('booking-error');
        const confirmBookingButton = document.getElementById('confirm-booking-button');
        const seatSelect = document.getElementById('seat-select'); // --- NEW ELEMENT ---

        // Manage Modal (for 'My Flights')
        const manageModal = document.getElementById('manage-modal');
        const cancelBookingButton = document.getElementById('cancel-booking-btn');
        const downloadManageReceiptBtn = document.getElementById('download-manage-receipt-btn');
        
        // Confirmation
        const downloadReceiptBtn = document.getElementById('download-receipt-btn');
        
        // Auth
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loggedInElements = document.querySelectorAll('.logged-in');
        const loggedOutElements = document.querySelectorAll('.logged-out');
        const sessionError = document.getElementById('session-error'); // --- NEW ELEMENT ---

        // 'My Flights' View
        const myFlightsList = document.getElementById('my-flights-list');
        const myFlightsMessage = document.getElementById('my-flights-message');

        // --- App State ---
        let currentFlightData = {};
        let lastBooking = {};
        let currentUser = null;
        let jwtToken = null;
        
        // --- 1. VIEW & AUTH MANAGEMENT ---
        
        function showView(viewId) {
            views.forEach(view => { view.style.display = 'none'; });
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                viewToShow.style.display = 'block';
            }
            
            // Special logic for views that need data
            if (viewId === 'my-flights-view') {
                loadUserBookings();
            }
            // Hide session error on view change
            sessionError.classList.add('hidden');
        }
        
        function updateNavUI() {
            if (currentUser && jwtToken) {
                // User is LOGGED IN
                loggedInElements.forEach(el => el.style.display = 'inline-block');
                loggedOutElements.forEach(el => el.style.display = 'none');
                document.getElementById('nav-user-name').textContent = `Hi, ${currentUser.name}`;
            } else {
                // User is LOGGED OUT
                loggedInElements.forEach(el => el.style.display = 'none');
                loggedOutElements.forEach(el => el.style.display = 'inline-block');
            }
        }
        
        function logoutUser(message = "Your session has expired. Please log in again.") {
            currentUser = null;
            jwtToken = null;
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userData');
            updateNavUI();
            
            // Show message on login screen
            sessionError.textContent = message;
            sessionError.classList.remove('hidden');
            showView('login-view');
        }
        
        // --- NEW: Function to populate dropdowns ---
        function populateCityDropdowns() {
            // Sort cities alphabetically
            CITIES.sort();
            
            CITIES.forEach(city => {
                const originOption = document.createElement('option');
                originOption.value = city;
                originOption.textContent = city;
                originSelect.appendChild(originOption);
                
                const destOption = document.createElement('option');
                destOption.value = city;
                destOption.textContent = city;
                destinationSelect.appendChild(destOption);
            });
        }
        
        // --- NEW: Function to generate seat options (ADDED IMPLEMENTATION) ---
        function populateSeatDropdown(seatsAvailable) {
            // Clear existing options, keeping the default disabled one
            seatSelect.innerHTML = '<option value="" disabled selected>Choose a seat...</option>';

            const totalRows = 20; // Assume max 20 rows
            const letters = ['A', 'B', 'C', 'D', 'E', 'F'];
            
            // Generate a pool of possible seats
            let allSeats = [];
            for (let i = 1; i <= totalRows; i++) {
                for (const letter of letters) {
                    allSeats.push(`${i}${letter}`);
                }
            }

            // Since we don't know *which* seats are booked, we just fill 
            // the dropdown with options equal to the number of seats available.
            // In a real app, this would be a check against the Booking table.
            
            const shuffledSeats = allSeats.sort(() => 0.5 - Math.random());
            const availableSeats = shuffledSeats.slice(0, seatsAvailable);

            availableSeats.forEach(seat => {
                const option = document.createElement('option');
                option.value = seat;
                option.textContent = seat;
                seatSelect.appendChild(option);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Populate dropdowns on load ---
            populateCityDropdowns();
            
            // Check if user is already logged in from localStorage
            const storedToken = localStorage.getItem('jwtToken');
            const storedUser = localStorage.getItem('userData');
            
            if (storedToken && storedUser) {
                jwtToken = storedToken;
                currentUser = JSON.parse(storedUser);
                updateNavUI();
                showView('search-view');
            } else {
                updateNavUI();
                showView('login-view'); // Start on login page if not logged in
            }
            
            // Set default date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayString = `${yyyy}-${mm}-${dd}`;
            document.getElementById('date').value = todayString;
        });
        
        // --- 2. AUTHENTICATION (Signup & Login) ---
        
        signupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const signupButton = document.getElementById('signup-button');
            const signupError = document.getElementById('signup-error');
            const signupSuccess = document.getElementById('signup-success');
            
            signupButton.disabled = true;
            signupButton.textContent = 'Creating...';
            signupError.classList.add('hidden');
            signupSuccess.classList.add('hidden');

            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password }),
                });
                const data = await response.json();
                
                if (!response.ok) {
                    signupError.textContent = `Error: ${data.error}`;
                    signupError.classList.remove('hidden');
                } else {
                    signupSuccess.textContent = 'Account created! Please log in.';
                    signupSuccess.classList.remove('hidden');
                    signupForm.reset();
                    // Wait 2 seconds and switch to login view
                    setTimeout(() => showView('login-view'), 2000);
                }
            } catch (error) {
                signupError.textContent = 'Network Error. Could not connect to server.';
                signupError.classList.remove('hidden');
            }
            signupButton.disabled = false;
            signupButton.textContent = 'Create Account';
        });

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            const loginError = document.getElementById('login-error');
            
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            loginError.classList.add('hidden');
            sessionError.classList.add('hidden'); // Clear session error too

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const data = await response.json();

                if (!response.ok) {
                    loginError.textContent = `Error: ${data.error}`;
                    loginError.classList.remove('hidden');
                } else {
                    // LOGIN SUCCESS
                    currentUser = data.user;
                    jwtToken = data.access_token;
                    
                    // Store session
                    localStorage.setItem('jwtToken', jwtToken);
                    localStorage.setItem('userData', JSON.stringify(currentUser));
                    
                    updateNavUI();
                    showView('search-view');
                    loginForm.reset();
                }
            } catch (error) {
                loginError.textContent = 'Network Error. Could not connect to server.';
                loginError.classList.remove('hidden');
            }
            loginButton.disabled = false;
            loginButton.textContent = 'Login';
        });

        // --- 3. FLIGHT SEARCH & DISPLAY ---
        
        searchForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';
            resultsList.innerHTML = ''; 
            resultsMessage.textContent = '';
            
            // --- UPDATED: Get value from select ---
            const origin = originSelect.value;
            const destination = destinationSelect.value;
            const date = document.getElementById('date').value;

            // --- NEW: Validation for dropdowns ---
            if (!origin || !destination) {
                showView('results-view');
                resultsMessage.textContent = 'Please select both an origin and a destination.';
                searchButton.disabled = false;
                searchButton.textContent = 'Search Flights';
                return;
            }
            if (origin === destination) {
                showView('results-view');
                resultsMessage.textContent = 'Origin and destination cannot be the same.';
                searchButton.disabled = false;
                searchButton.textContent = 'Search Flights';
                return;
            }

            const url = `${API_BASE_URL}/api/flights/search?origin=${origin}&destination=${destination}&date=${date}`;

            try {
                const response = await fetch(url); // No token needed
                showView('results-view'); 

                if (response.status === 404) {
                    const data = await response.json();
                    resultsMessage.textContent = data.message;
                } else if (!response.ok) {
                    const data = await response.json();
                    resultsMessage.textContent = `Error: ${data.error}`;
                } else {
                    const flights = await response.json();
                    displayFlights(flights);
                }
            } catch (error) {
                showView('results-view');
                resultsMessage.textContent = `Network Error: Could not connect to the server. Is it running?`;
                console.error('Fetch Error:', error);
            }

            searchButton.disabled = false;
            searchButton.textContent = 'Search Flights';
        });

        function displayFlights(flights) {
            if (flights.length === 0) {
                // --- UPDATED: Clearer message ---
                resultsMessage.textContent = 'No flights were found for this route on this date.';
                return;
            }
            currentFlightData = {}; 
            flights.forEach(flight => {
                currentFlightData[flight.id] = flight;
                const departure = new Date(flight.departure_time);
                const arrival = new Date(flight.arrival_time);
                
                const flightCard = `
                    <div class="bg-white p-4 rounded-lg shadow-md flex flex-col md:flex-row justify-between items-center">
                        <div class="mb-4 md:mb-0">
                            <div class="flex items-center space-x-4">
                                <span class="text-xl font-bold text-indigo-600">${flight.flight_number}</span>
                                <div>
                                    <p class="text-lg font-semibold">${flight.origin} &rarr; ${flight.destination}</p>
                                    <p class="text-sm text-gray-600">
                                        ${departure.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - 
                                        ${arrival.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                            <div class="text-center md:text-right">
                                <p class="text-2xl font-bold text-indigo-600">$${flight.dynamic_price} <span class="text-xs font-normal text-indigo-400">Current Fare</span></p>
                                <p class="text-sm text-gray-500 line-through">$${flight.base_price} (Base)</p>
                                <p class="text-sm font-medium ${flight.seats_available < 20 ? 'text-red-600' : 'text-green-600'}">
                                    ${flight.seats_available} seats left
                                </p>
                            </div>
                            <button 
                                onclick="openBookingModal(${flight.id})" 
                                class="w-full md:w-auto bg-green-600 text-white py-2 px-6 rounded-md shadow-sm hover:bg-green-700 disabled:opacity-50"
                                ${flight.seats_available === 0 ? 'disabled' : ''}>
                                ${flight.seats_available === 0 ? 'Sold Out' : 'Book Now'}
                            </button>
                        </div>
                    </div>
                `;
                resultsList.innerHTML += flightCard;
            });
        }
        
        // --- NEW UTILITY: Handle Auth Error (401) ---
        function handleAuthError(responseStatus) {
            if (responseStatus === 401) {
                // If the token is invalid or expired, log the user out gracefully
                logoutUser();
                return true; 
            }
            return false; 
        }

        // --- 4. BOOKING CREATION & MODAL ---
        
        function openBookingModal(flightId) {
            if (!currentUser) {
                // User is logged out, redirect them to login page to see the session error message
                logoutUser("Please log in to book a flight.");
                return;
            }
            
            const flight = currentFlightData[flightId];
            document.getElementById('modal-flight-id').value = flight.id;
            document.getElementById('modal-flight-number').textContent = flight.flight_number;
            document.getElementById('modal-origin').textContent = flight.origin;
            document.getElementById('modal-destination').textContent = flight.destination;
            document.getElementById('modal-price').textContent = `$${flight.dynamic_price}`;
            document.getElementById('modal-user-name').textContent = currentUser.name;
            
            // --- NEW: Populate seat dropdown (This was the fix!) ---
            populateSeatDropdown(flight.seats_available); 

            bookingError.classList.add('hidden');
            bookingError.textContent = '';
            bookingForm.reset();
            confirmBookingButton.disabled = false;
            confirmBookingButton.textContent = 'Confirm & Pay';

            bookingModal.style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == bookingModal) {
                closeModal('booking-modal');
            }
            if (event.target == manageModal) {
                closeModal('manage-modal');
            }
        }
        
        bookingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            confirmBookingButton.disabled = true;
            confirmBookingButton.textContent = 'Processing...';
            bookingError.classList.add('hidden');

            // --- NEW: Check for JWT Token before attempting network call ---
            if (!jwtToken) {
                logoutUser("Your login session has ended. Please log in before confirming your booking.");
                return;
            }

            const flightId = document.getElementById('modal-flight-id').value;
            const seatNumber = seatSelect.value;
            
            // --- Input validation for seat dropdown ---
            if (!seatNumber) {
                bookingError.textContent = "Please select a seat number.";
                bookingError.classList.remove('hidden');
                confirmBookingButton.disabled = false;
                confirmBookingButton.textContent = 'Confirm & Pay';
                return;
            }

            const bookingData = {
                flight_id: parseInt(flightId),
                seat_number: seatNumber
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/bookings/create`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify(bookingData),
                });
                
                // --- UPDATED: Check for 401 using new utility ---
                if (handleAuthError(response.status)) {
                    return;
                }
                
                // --- UPDATED: Robust Error Handling (Read as text first for bad status, then parse) ---
                const responseText = await response.text();
                
                if (!response.ok) {
                    let errorMessage = "Booking Failed: An unknown error occurred.";
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = `Booking Failed: ${errorData.error || responseText}`;
                    } catch (jsonError) {
                        // If it's not JSON, it's probably a server crash page
                        errorMessage = `Booking Failed: Server Error (Status ${response.status} - ${response.statusText}). Is app.py running?`;
                        console.error("Server returned non-JSON error:", responseText);
                    }
                    
                    bookingError.textContent = errorMessage;
                    bookingError.classList.remove('hidden');
                    confirmBookingButton.disabled = false;
                    confirmBookingButton.textContent = 'Confirm & Pay';
                } else {
                    // Booking SUCCESS (must parse JSON now)
                    const data = JSON.parse(responseText);
                    showConfirmationPage(data.booking);
                }
            } catch (error) {
                // --- UPDATED: Clearer Network Error message ---
                bookingError.textContent = `Network Error: Could not connect to the server (Is app.py running and accessible?).`;
                bookingError.classList.remove('hidden');
                console.error('Booking Error:', error);
                confirmBookingButton.disabled = false;
                confirmBookingButton.textContent = 'Confirm & Pay';
            }
        });

        // --- 5. BOOKING CONFIRMATION ---
        
        function showConfirmationPage(booking) {
            closeModal('booking-modal');
            lastBooking = booking; // Store for receipt download
            
            document.getElementById('pnr-display').textContent = booking.pnr;
            showView('confirmation-view');
            
            // Hook up the download button
            downloadReceiptBtn.onclick = () => downloadFullReceipt(booking.pnr);
        }

        // --- 6. 'MY FLIGHTS' & CANCELLATION ---
        
        async function loadUserBookings() {
            myFlightsList.innerHTML = '';
            myFlightsMessage.textContent = 'Loading your flights...';

            if (!jwtToken) {
                myFlightsMessage.textContent = 'Please log in to see your flights.';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/bookings/my-bookings`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                
                if (handleAuthError(response.status)) { // Check for 401
                    return;
                }
                
                const data = await response.json();

                if (!response.ok) {
                    myFlightsMessage.textContent = `Error: ${data.error}`;
                } else {
                    if (data.length === 0) {
                        // --- UPDATED: Clearer message ---
                        myFlightsMessage.textContent = "You don't have any booked flights yet.";
                    } else {
                        myFlightsMessage.textContent = '';
                        displayUserBookings(data);
                    }
                }
            } catch (error) {
                myFlightsMessage.textContent = 'Network Error. Could not connect to server.';
                console.error('Manage Error:', error);
            }
        }
        
        function displayUserBookings(bookings) {
            bookings.forEach(booking => {
                const departure = new Date(booking.departure_time);
                const bookingCard = `
                    <div id="booking-card-${booking.pnr}" class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="mb-4 md:mb-0">
                                <p class="text-sm text-gray-500">PNR: <span class="font-mono font-bold text-gray-800">${booking.pnr}</span></p>
                                <p class="text-xl font-semibold">${booking.origin} &rarr; ${booking.destination}</p>
                                <p class="text-gray-700">${booking.flight_number} - Seat ${booking.seat_number}</p>
                                <p class="text-sm text-gray-600">Departs: ${departure.toLocaleString()}</p>
                            </div>
                            <div class="flex flex-col items-stretch md:items-end w-full md:w-auto space-y-2">
                                <div class="text-left md:text-right">
                                    <span id="booking-status-${booking.pnr}" class="text-lg font-bold ${booking.status === 'CONFIRMED' ? 'text-green-600' : 'text-red-600'}">
                                        ${booking.status}
                                    </span>
                                    <p class="text-lg font-semibold">$${booking.price_paid}</p>
                                </div>
                                <button onclick="openManageModal('${booking.pnr}')" class="bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700">
                                    Manage
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                myFlightsList.innerHTML += bookingCard;
            });
        }
        
        async function openManageModal(pnr) {
            const modalBody = document.getElementById('manage-modal-body');
            modalBody.innerHTML = '<p>Loading details...</p>';
            manageModal.style.display = 'block';

            // Clear messages
            document.getElementById('manage-modal-error').classList.add('hidden');
            document.getElementById('manage-modal-success').classList.add('hidden');

            try {
                // Fetch the single booking details
                const response = await fetch(`${API_BASE_URL}/api/bookings/${pnr}`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                
                if (handleAuthError(response.status)) { // Check for 401
                    closeModal('manage-modal');
                    return;
                }
                
                const booking = await response.json();

                if (!response.ok) {
                    modalBody.innerHTML = `<p class="text-red-600">Error: ${booking.error}</p>`;
                    return;
                }

                // Store for cancellation/download
                let currentManagedBooking = booking; 
                const departure = new Date(booking.departure_time);
                
                modalBody.innerHTML = `
                    <p><strong>PNR:</strong> <span class="font-mono font-bold">${booking.pnr}</span></p>
                    <p><strong>Status:</strong> <span id="manage-status" class="font-medium ${booking.status === 'CONFIRMED' ? 'text-green-600' : 'text-red-600'}">${booking.status}</span></p>
                    <hr class="my-3">
                    <p><strong>Passenger:</strong> ${booking.passenger_name}</p>
                    <p><strong>Email:</strong> ${booking.passenger_email}</p>
                    <p><strong>Flight:</strong> ${booking.flight_number} (${booking.origin} &rarr; ${booking.destination})</p>
                    <p><strong>Departs:</strong> ${departure.toLocaleString()}</p>
                    <p><strong>Seat:</strong> ${booking.seat_number}</p>
                    <p><strong>Price Paid:</strong> $${booking.price_paid}</p>
                `;
                
                // Show/hide cancel button
                if (booking.status === 'CONFIRMED') {
                    cancelBookingButton.style.display = 'block';
                    cancelBookingButton.disabled = false;
                    cancelBookingButton.textContent = 'Cancel Booking';
                } else {
                    cancelBookingButton.style.display = 'none';
                }
                
                // Hook up download button
                downloadManageReceiptBtn.onclick = () => downloadJSON(currentManagedBooking, `Booking-${currentManagedBooking.pnr}.json`);
                
                // Hook up cancel button (must re-hook every time)
                cancelBookingButton.onclick = () => handleCancelBooking(pnr);
                
            } catch (error) {
                modalBody.innerHTML = `<p class="text-red-600">Network Error: ${error.message}</p>`;
            }
        }

        async function handleCancelBooking(pnr) {
            if (!pnr) return;

            cancelBookingButton.disabled = true;
            cancelBookingButton.textContent = 'Cancelling...';

            const errorMsg = document.getElementById('manage-modal-error');
            const successMsg = document.getElementById('manage-modal-success');
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/bookings/${pnr}/cancel`, { 
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` } 
                });
                
                if (handleAuthError(response.status)) { // Check for 401
                    closeModal('manage-modal');
                    return;
                }
                
                const data = await response.json();

                if (!response.ok) {
                    errorMsg.textContent = `Error: ${data.error}`;
                    errorMsg.classList.remove('hidden');
                    cancelBookingButton.disabled = false;
                    cancelBookingButton.textContent = 'Cancel Booking';
                } else {
                    // Success! Update the UI in the modal AND the list behind it
                    successMsg.textContent = 'Booking successfully cancelled.';
                    successMsg.classList.remove('hidden');
                    document.getElementById('manage-status').textContent = 'CANCELLED';
                    document.getElementById('manage-status').classList.remove('text-green-600');
                    document.getElementById('manage-status').classList.add('text-red-600');
                    cancelBookingButton.style.display = 'none';
                    
                    // Update the 'My Flights' list in the background
                    document.getElementById(`booking-status-${pnr}`).textContent = 'CANCELLED';
                    document.getElementById(`booking-status-${pnr}`).classList.remove('text-green-600');
                    document.getElementById(`booking-status-${pnr}`).classList.add('text-red-600');
                }
            } catch (error) {
                errorMsg.textContent = 'Network Error. Could not connect to server.';
                errorMsg.classList.remove('hidden');
                cancelBookingButton.disabled = false;
                cancelBookingButton.textContent = 'Cancel Booking';
            }
        }

        // --- 7. UTILITY FUNCTIONS (Download JSON) ---
        
        async function downloadFullReceipt(pnr) {
            // We fetch the full details first to make sure the receipt is accurate
            try {
                const response = await fetch(`${API_BASE_URL}/api/bookings/${pnr}`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });
                
                if (handleAuthError(response.status)) { // Check for 401
                    return;
                }
                
                const bookingData = await response.json();
                
                if (!response.ok) {
                    // Keeping alert here for simple feedback on a non-core failure
                    alert(`Error fetching receipt: ${bookingData.error}`); 
                } else {
                    downloadJSON(bookingData, `Booking-${pnr}.json`);
                }
            } catch (error) {
                // Keeping alert here for simple feedback on a non-core failure
                alert(`Network error fetching receipt: ${error.message}`); 
            }
        }
        
        function downloadJSON(data, filename) {
            const receiptData = {
                pnr: data.pnr,
                status: data.status,
                passenger: data.passenger_name,
                email: data.passenger_email,
                flight: data.flight_number,
                origin: data.origin,
                destination: data.destination,
                departure: data.departure_time,
                seat: data.seat_number,
                price_paid: data.price_paid,
                booking_time: data.booking_time
            };
        
            const jsonStr = JSON.stringify(receiptData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>